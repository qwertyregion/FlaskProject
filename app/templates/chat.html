{% extends "base.html" %}

{% block link %}
    <link href="{{ url_for('static', filename='css/chat.css')}}?v={{config['VERSION']}}" rel="stylesheet">
{% endblock link %}

{% block script %}
    <!-- Скрипты будут загружены в конце страницы -->
{% endblock script %}

{% block style %}  {% endblock style %}

{% block content %}

    {% if not current_user.is_authenticated %}
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Ошибка доступа!</h4>
        <p>Для использования чата необходимо войти в систему.</p>
        <hr>
        <p class="mb-0">
            <a href="{{ url_for('auth.login') }}" class="btn btn-primary">Войти</a>
            <a href="{{ url_for('auth.register') }}" class="btn btn-secondary">Регистрация</a>
        </p>
    </div>
    {% else %}
    <div class="chat-container">
        <!-- Боковая панель с комнатами -->
        <div class="sidebar">

            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="rooms">Комнаты</button>
                <button class="tab-btn" data-tab="dms">Личные сообщения</button>
            </div>

            <!-- Список комнат -->
            <div class="tab-content active" id="rooms-tab">
                <button onclick="showCreateRoomInput()">+ Создать тему чата</button>
                <ul id="rooms-list"></ul>
            </div>

            <!-- Список диалогов -->
            <div class="tab-content" id="dms-tab">
                <div class="dm-header">
                    <h4>Диалоги</h4>
                </div>
                <ul id="dm-conversations"></ul>
            </div>

            <!-- Форма для создания комнаты -->
            <div id="room-create">
                <input type="text" id="new-room-name" placeholder="тема чата" required>
                <div class="error-message"></div>
                <button onclick="submitCreateRoom()">OK</button>
            </div>
        </div>

        <!-- Основное содержимое чата -->
        <div class="main-content">
            <h1>Чат: <span id="current-room">general_chat</span></h1>

            <div id="users-list">
                <h3>Участники: (<span id="online-count">0</span>):</h3>
                <ul id="active-users"></ul>
            </div>

            <div id="chat-box"></div>

            <form id="message-form">
                <input type="text" id="message-input" placeholder="Напишите сообщение..." required>
                <button type="submit">Отправить</button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Загружаем скрипты в конце страницы -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <!-- Данные пользователя -->
    <div id="user-data" 
         data-user-id="{% if current_user.is_authenticated %}{{ current_user.id }}{% else %}null{% endif %}"
         data-username="{% if current_user.is_authenticated %}{{ current_user.username|e }}{% else %}null{% endif %}"
         data-email="{% if current_user.is_authenticated %}{{ current_user.email|e }}{% else %}null{% endif %}"
         data-authenticated="{% if current_user.is_authenticated %}true{% else %}false{% endif %}"
         style="display: none;">
    </div>
    
    <!-- Загружаем модули чата -->
    <script src="{{ url_for('static', filename='js/modules/user-init.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/dm-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/chat-ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/socket-handlers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/virtualized-chat.js') }}"></script>
    
    <!-- Основной файл чата -->
    <script src="{{ url_for('static', filename='js/chat-modular.js') }}"></script>

{% endblock %}
